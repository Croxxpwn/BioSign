{% extends "mobile.base.html" %}

{% block head %}
<script src="/static/mobile/RecorderJS/recorder.js"></script>
<title>Biosign Mobile登录</title>
{% endblock %}


{% block content %}

<div data-role="main" class="ui-content">
    <div class="ui-grid-solo">
        <div class="ui-block-a">
            <input type="text" id="hint" value="请朗读并录制如下文本!" disabled>
        </div>
    </div>

    <div class="ui-grid-solo">
        <div class="ui-block-a">
            <a href="#" id="snap" class="ui-btn ui-corner-all ui-shadow">按下录制/松开上传</a>
        </div>
    </div>
</div>

<script>
    var recorder;
    var input;

    function startUserMedia(stream) {
        var input = audio_context.createMediaStreamSource(stream);
        // Uncomment if you want the audio to feedback directly
        //input.connect(audio_context.destination);
        //__log('Input connected to audio context destination.');
        recorder = new Recorder(input);
    }

    $(document).ready(function () {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
            window.URL = window.URL || window.webkitURL;

            audio_context = new AudioContext;
            __log('Audio context set up.');
            __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
        } catch (e) {
            alert('No web audio support in this browser!');
        }


        navigator.getUserMedia({audio: true}, startUserMedia, function (e) {
        });
    });

    function blobToDataURL(blob, callback) {
        var a = new FileReader();
        a.onload = function (e) {
            callback(e.target.result);
        }
        a.readAsDataURL(blob);
    }

    $("#snap").on("vmousedown", function () {
        recorder.record();
    });

    $("#snap").on("vmouseup", function () {
        recorder.stop();
        recorder.exportWAV(function (blob) {

            var reader = new FileReader();
            reader.onload = function (e) {
                ajaxdata(e.target.result)
            };
            reader.readAsDataURL(blob);

        });
    });

    function ajaxdata(voice) {
        console.log(voice);
        var csrftoken = "{{csrf_token()|safe}}";
        var data = {'voice': voice};
        $.ajax({
            type: 'POST',
            url: "/mobile/ajax/register/voice",
            data: data,
            dataType: "json",
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function (data) {
                if (data.status_code == 200) {
                    window.location.href = "/mobile/index";
                } else {
                    $("#hint").val("人脸识别失败,请上传清晰人脸!");
                }
            },
            error: function (xhr, type) {
            }
        });

    }

    /*
    document.getElementById("snap").addEventListener("click", function () {
        context.drawImage(video, 0, 0, 150, 200);
        dataURL = canvas.toDataURL('image/jpeg');
        var data = {'face': dataURL};
        var csrftoken = "{{csrf_token()|safe}}";
        $.ajax({
            type: 'POST',
            url: "/mobile/ajax/register/face",
            processData: false,
            data: "your blob object",
            dataType: 'json',
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function (data) {
                if (data.status_code == 200) {
                    window.location.href = "/mobile/index";
                } else {
                    $("#hint").val("人脸识别失败,请上传清晰人脸!");
                }
            },
            error: function (xhr, type) {
            }
        });
    });
    */
</script>

{% endblock %}





